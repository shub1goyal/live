<!DOCTYPE html>
<html>
<head>
  <title>Revenue Allocation Tool</title>
  <!-- Add SheetJS library for Excel export -->
  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      /* Light mode variables */
      --primary: #3a86ff;
      --primary-light: #8ecae6;
      --primary-dark: #023e8a;
      --accent: #fb8500;
      --success: #38b000;
      --danger: #e5383b;
      --warning: #ffb703;
      --bg: #f8f9fa;
      --card: #ffffff;
      --text: #212529;
      --text-light: #6c757d;
      --border: #dee2e6;
      --shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
      --table-head: var(--primary);
      --table-head-text: #ffffff;
      --table-stripe: rgba(0,0,0,0.02);
      --table-foot: #f1f5f9;
      --summary-bg: #f1f5f9;
    }
    
    /* Dark mode variables */
    [data-theme="dark"] {
      --primary: #4cc9f0;
      --primary-light: #7209b7;
      --primary-dark: #3f37c9;
      --accent: #ff9e00;
      --success: #57cc99;
      --danger: #e63946;
      --warning: #ffb703;
      --bg: #121212;
      --card: #1e1e1e;
      --text: #e9ecef;
      --text-light: #adb5bd;
      --border: #343a40;
      --shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      --table-head: #3a0ca3;
      --table-head-text: #ffffff;
      --table-stripe: rgba(255,255,255,0.03);
      --table-foot: #212529;
      --summary-bg: #212529;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      padding: 1rem;
      line-height: 1.5;
      font-size: 14px;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    
    h2 {
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--text);
      font-size: 1.5rem;
    }
    
    h3, h4 {
      font-weight: 500;
      margin: 1rem 0 0.75rem;
      color: var(--text);
      font-size: 1.15rem;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: var(--card);
      border-radius: 8px;
      box-shadow: var(--shadow);
      padding: 1.25rem;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
      border-radius: 4px;
      overflow: hidden;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      font-size: 0.9rem;
      transition: box-shadow 0.3s ease;
    }
    
    th, td {
      padding: 0.5rem 0.75rem;
      text-align: left;
      border: none;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    
    th {
      background: var(--table-head);
      color: var(--table-head-text);
      font-weight: 500;
      font-size: 0.85rem;
    }
    
    tr:nth-child(even) {
      background-color: var(--table-stripe);
    }
    
    input[type="text"], input[type="number"] {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 0.9rem;
      background-color: var(--card);
      color: var(--text);
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out, background-color 0.3s ease, color 0.3s ease;
    }
    
    input[type="text"]:focus, input[type="number"]:focus {
      outline: none;
      border-color: var(--primary-light);
      box-shadow: 0 0 0 2px rgba(142, 202, 230, 0.2);
    }
    
    .placeholder {
      color: var(--text-light);
      font-style: italic;
    }
    
    .button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem 0.75rem;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.85rem;
      transition: all 0.2s ease;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .button:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .button:active {
      transform: translateY(0);
    }
    
    .button i {
      margin-right: 0.35rem;
      font-size: 0.9rem;
    }
    
    .toolbar {
      margin: 0.75rem 0;
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
    }
    
    .excel-btn {
      background: var(--primary);
    }
    
    .excel-btn:hover {
      background: var(--primary-dark);
    }
    
    .delete-btn {
      background: var(--danger);
    }
    
    .delete-btn:hover {
      opacity: 0.9;
    }
    
    .import-export-btn {
      background: var(--accent);
    }
    
    .import-export-btn:hover {
      opacity: 0.9;
    }
    
    .decimal-control {
      display: flex;
      align-items: center;
      background: var(--card);
      padding: 0.75rem;
      border-radius: 6px;
      margin: 0.75rem 0;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .decimal-control strong {
      margin-right: 0.75rem;
      white-space: nowrap;
      font-size: 0.9rem;
    }
    
    .decimal-btn {
      width: 28px;
      height: 28px;
      font-size: 1rem;
      font-weight: bold;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--primary);
      border-radius: 50%;
    }
    
    .decimal-display {
      padding: 0.35rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 4px;
      margin: 0 0.5rem;
      background: var(--card);
      color: var(--text);
      font-weight: 500;
      min-width: 40px;
      text-align: center;
      font-size: 0.9rem;
    }
    
    .instructions-container {
      position: relative;
      margin-bottom: 1rem;
    }
    
    .instructions-button {
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 50%;
      padding: 0;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.9rem;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      right: 0;
      top: 0;
      transition: all 0.2s ease;
    }
    
    .instructions-button:hover {
      background-color: var(--primary-dark);
      transform: scale(1.05);
    }
    
    .instructions-content {
      display: none;
      background-color: var(--card);
      border-left: 3px solid var(--primary);
      padding: 0.75rem 1rem;
      margin-top: 0.75rem;
      font-size: 0.85rem;
      line-height: 1.5;
      z-index: 100;
      border-radius: 0 4px 4px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    
    .instructions-content p {
      margin-bottom: 0.5rem;
    }
    
    .instructions-content ol {
      padding-left: 1.25rem;
    }
    
    .instructions-content li {
      margin-bottom: 0.35rem;
    }
    
    .instructions-button:hover + .instructions-content,
    .instructions-content:hover {
      display: block;
    }
    
    .export-options {
      padding: 1rem;
      border-radius: 6px;
      background-color: var(--card);
    }
    
    .export-options h4 {
      margin-top: 0;
      margin-bottom: 0.75rem;
      font-weight: 500;
      font-size: 1rem;
    }
    
    .export-options label {
      display: block;
      margin-bottom: 0.75rem;
      font-weight: 500;
      font-size: 0.9rem;
    }
    
    .export-options input {
      width: 100%;
      max-width: 250px;
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: 4px;
      margin-top: 0.25rem;
      font-size: 0.9rem;
    }
    
    .export-footer {
      margin-top: 1rem;
      display: flex;
      gap: 0.5rem;
    }
    
    .summary-box {
      background-color: var(--card);
      border-radius: 6px;
      padding: 0.75rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
    }
    
    .summary-box label {
      font-weight: 500;
      margin-right: 0.75rem;
      white-space: nowrap;
      font-size: 0.9rem;
    }
    
    .summary-box input {
      flex: 1;
      max-width: 250px;
    }
    
    .summary-value {
      background-color: var(--summary-bg);
      padding: 0.35rem 0.75rem;
      border-radius: 4px;
      font-weight: 500;
      min-width: 100px;
      text-align: right;
      font-size: 0.9rem;
      color: var(--text);
    }
    
    .row-selector-cell {
      width: 32px;
      text-align: center;
    }
    
    input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
      border-radius: 2px;
      border: 1px solid var(--border);
    }
    
    /* Modal styles */
    .modal-overlay {
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background-color: var(--card);
      padding: 1.5rem;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 25px -5px rgba(0,0,0,0.2);
      animation: slideIn 0.3s ease-out;
      color: var(--text);
    }
    
    @keyframes slideIn {
      from {
        transform: translateY(-15px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    /* Table cell widths */
    .segment-cell { width: 30%; }
    .activity-cell { width: 40%; }
    .revenue-cell { width: 20%; }
    
    /* Table footers */
    tfoot tr {
      background-color: var(--table-foot) !important;
      font-weight: 600;
    }
    
    tfoot th {
      background-color: var(--table-foot) !important;
      color: var(--text);
      text-transform: none;
    }
    
    /* Dark mode toggle */
    .theme-toggle {
      position: absolute;
      top: 1rem;
      right: 1rem;
      display: flex;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }
    
    .theme-toggle-track {
      width: 40px;
      height: 20px;
      border-radius: 10px;
      background-color: var(--text-light);
      position: relative;
      transition: background-color 0.3s ease;
      margin-left: 0.5rem;
    }
    
    .theme-toggle-thumb {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background-color: white;
      transition: transform 0.3s ease;
    }
    
    [data-theme="dark"] .theme-toggle-track {
      background-color: var(--primary);
    }
    
    [data-theme="dark"] .theme-toggle-thumb {
      transform: translateX(20px);
    }
    
    .theme-toggle-icon {
      font-size: 14px;
      color: var(--text);
    }
    
    .theme-toggle-label {
      font-size: 0.85rem;
      margin-right: 0.5rem;
      color: var(--text);
    }
    
    @media (max-width: 768px) {
      .theme-toggle {
        top: 0.75rem;
        right: 0.75rem;
      }
      
      .theme-toggle-label {
        display: none;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <h2>Revenue Allocation Calculator</h2>
  
  <div class="theme-toggle" onclick="toggleTheme()">
    <span class="theme-toggle-label">Dark Mode</span>
    <div class="theme-toggle-track">
      <div class="theme-toggle-thumb"></div>
    </div>
  </div>

  <div class="instructions-container">
    <button class="instructions-button" title="Instructions">‚ùì</button>
    <div class="instructions-content">
      <p><strong>How to use this tool:</strong></p>
      <ol>
        <li>Enter your revenue data by segment and Busines activity in the table below</li>
        <li>Enter your CIQ Revenue value</li>
        <li>The tool will automatically calculate how CIQ Revenue should be allocated across activities</li>
        <li>Use the +/- buttons to adjust decimal places for the apportioned revenue</li>
        <li>Add rows with the Add Row button or by pressing Enter in the Revenue field</li>
        <li>Configure your export filename format and export to Excel</li>
      </ol>
    </div>
  </div>

  <div class="toolbar">
    <button class="button excel-btn" onclick="addRow()">‚ûï Add Row</button>
    <button class="button delete-btn" onclick="deleteSelectedRows()">üóëÔ∏è Delete Selected</button>
    <button class="button delete-btn" onclick="clearAll()">üßπ Clear All</button>
    <button class="button import-export-btn" onclick="showExportOptions()">üì§ Export to Excel</button>
  </div>

  <table id="inputTable">
    <thead>
      <tr>
        <th class="row-selector-cell"><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>
        <th class="segment-cell">Segment</th>
        <th class="activity-cell">Business Activity</th>
        <th class="revenue-cell">Revenue</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td class="row-selector-cell"><input type="checkbox" class="rowSelector"></td>
        <td class="segment-cell"><input type="text" oninput="calculate()" placeholder="e.g., Manufacturing (NAICS 31-33)" class="placeholder" onfocus="clearPlaceholder(this)" onblur="restorePlaceholder(this, 'e.g., Manufacturing (NAICS 31-33)')"></td>
        <td class="activity-cell"><input type="text" oninput="calculate()" placeholder="e.g., Computer Manufacturing (NAICS 334110)" class="placeholder" onfocus="clearPlaceholder(this)" onblur="restorePlaceholder(this, 'e.g., Computer Manufacturing (NAICS 334110)')"></td>
        <td class="revenue-cell"><input type="number" oninput="calculate()" onkeydown="handleEnterKey(event)" placeholder="e.g., 750000" class="placeholder" onfocus="clearPlaceholder(this)" onblur="restorePlaceholder(this, 'e.g., 750000')"></td>
      </tr>
      <tr>
        <td class="row-selector-cell"><input type="checkbox" class="rowSelector"></td>
        <td><input type="text" oninput="calculate()" placeholder="e.g., Finance (NAICS 52)" class="placeholder" onfocus="clearPlaceholder(this)" onblur="restorePlaceholder(this, 'e.g., Finance (NAICS 52)')"></td>
        <td><input type="text" oninput="calculate()" placeholder="e.g., Commercial Banking (NAICS 522110)" class="placeholder" onfocus="clearPlaceholder(this)" onblur="restorePlaceholder(this, 'e.g., Commercial Banking (NAICS 522110)')"></td>
        <td><input type="number" oninput="calculate()" onkeydown="handleEnterKey(event)" placeholder="e.g., 1250000" class="placeholder" onfocus="clearPlaceholder(this)" onblur="restorePlaceholder(this, 'e.g., 1250000')"></td>
      </tr>
      <tr>
        <td class="row-selector-cell"><input type="checkbox" class="rowSelector"></td>
        <td><input type="text" oninput="calculate()" placeholder="e.g., Healthcare (NAICS 62)" class="placeholder" onfocus="clearPlaceholder(this)" onblur="restorePlaceholder(this, 'e.g., Healthcare (NAICS 62)')"></td>
        <td><input type="text" oninput="calculate()" placeholder="e.g., Hospitals (NAICS 622110)" class="placeholder" onfocus="clearPlaceholder(this)" onblur="restorePlaceholder(this, 'e.g., Hospitals (NAICS 622110)')"></td>
        <td><input type="number" oninput="calculate()" onkeydown="handleEnterKey(event)" placeholder="e.g., 950000" class="placeholder" onfocus="clearPlaceholder(this)" onblur="restorePlaceholder(this, 'e.g., 950000')"></td>
      </tr>
    </tbody>
  </table>

  <div class="summary-box">
    <label>Total Revenue:</label>
    <span id="totalRevenue" class="summary-value">0</span>
  </div>

  <div class="summary-box">
    <label><strong>CIQ Revenue:</strong></label>
    <input type="number" id="ciqRevenue" value="0" oninput="calculate()" placeholder="Enter CIQ Revenue" class="placeholder" onfocus="clearPlaceholder(this)" onblur="restorePlaceholder(this, 'Enter CIQ Revenue')">
  </div>

  <div class="decimal-control">
    <strong>Decimal Places for Apportioned Revenue:</strong>
    <button class="button decimal-btn" onclick="changeDecimals(-1)">-</button>
    <span id="decimalDisplay" class="decimal-display">2</span>
    <button class="button decimal-btn" onclick="changeDecimals(1)">+</button>
  </div>

  <h3>Business Activity Revenue Breakdown</h3>
  <table id="activityTable">
    <thead>
      <tr>
        <th>Business Activity</th>
        <th>Revenue</th>
        <th>% of Total Revenue</th>
        <th>Apportioned Revenue<br>(Using CIQ Revenue)</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <th style="text-align: right;">Total:</th>
        <th id="totalActivityRevenue">0</th>
        <th>100%</th>
        <th id="totalCIQApportioned">0</th>
      </tr>
    </tfoot>
  </table>
</div>

<!-- Export Options Modal -->
<div id="exportOptionsModal" class="modal-overlay" style="display: none;">
  <div class="modal-content">
    <h3>Export Options</h3>
    <div class="export-options">
      <h4>Filename Format: UID_date_Initials</h4>
      <label>
        UID:
        <input type="number" id="uidInput" placeholder="Enter UID" value="1001">
      </label>
      <label>
        Initials:
        <input type="text" id="initialsInput" placeholder="Enter your initials" value="">
      </label>
      <div class="export-footer">
        <button class="button excel-btn" onclick="exportToExcel()">Export</button>
        <button class="button delete-btn" onclick="hideExportOptions()">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script>
// Store decimal places as a variable
let decimalPlaces = 2;
// Store user initials
let userInitials = localStorage.getItem('userInitials') || '';
// Store theme preference
let currentTheme = localStorage.getItem('theme') || 'light';

// Set theme on initial load
document.documentElement.setAttribute('data-theme', currentTheme);

// Function to toggle theme
function toggleTheme() {
  currentTheme = currentTheme === 'light' ? 'dark' : 'light';
  document.documentElement.setAttribute('data-theme', currentTheme);
  localStorage.setItem('theme', currentTheme);
}

function formatNum(num, decimals) {
  if (isNaN(num)) return 'N/A';
  return decimals !== undefined ? num.toFixed(decimals) : num.toString();
}

function changeDecimals(change) {
  // Update decimal places (minimum 0, maximum 10)
  decimalPlaces = Math.max(0, Math.min(10, decimalPlaces + change));
  
  // Update the display
  document.getElementById('decimalDisplay').textContent = decimalPlaces;
  
  // Recalculate with new decimal places
  calculate();
}

function clearPlaceholder(element) {
  if (element.classList.contains('placeholder')) {
    element.classList.remove('placeholder');
    element.placeholder = '';
  }
}

function restorePlaceholder(element, placeholderText) {
  if (element.value === '') {
    element.classList.add('placeholder');
    element.placeholder = placeholderText;
  }
}

function calculate() {
  const rows = document.querySelectorAll('#inputTable tbody tr');
  const data = [];

  rows.forEach(row => {
    const inputs = row.querySelectorAll('input:not([type="checkbox"])');
    const segment = inputs[0].value.trim();
    const activity = inputs[1].value.trim();
    const revenue = parseFloat(inputs[2].value || 0);
    if (activity && !isNaN(revenue)) {
      data.push({ segment, activity, revenue });
    }
  });

  const totalRevenue = data.reduce((sum, row) => sum + row.revenue, 0);
  document.getElementById('totalRevenue').textContent = formatNum(totalRevenue);

  const ciqRevenue = parseFloat(document.getElementById('ciqRevenue').value || 0);
  const revenueByActivity = {};
  
  data.forEach(row => {
    if (!revenueByActivity[row.activity]) {
      revenueByActivity[row.activity] = 0;
    }
    revenueByActivity[row.activity] += row.revenue;
  });

  const tbody = document.querySelector('#activityTable tbody');
  tbody.innerHTML = "";
  let totalApportioned = 0;
  let totalActivityRevenue = 0;

  for (const [activity, rev] of Object.entries(revenueByActivity)) {
    const percent = (rev / totalRevenue) * 100;
    const apportioned = (rev / totalRevenue) * ciqRevenue;
    totalApportioned += apportioned;
    totalActivityRevenue += rev;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${activity}</td>
      <td>${formatNum(rev)}</td>
      <td>${formatNum(percent, 2)}%</td>
      <td>${formatNum(apportioned, decimalPlaces)}</td>
    `;
    tbody.appendChild(tr);
  }

  document.getElementById('totalCIQApportioned').textContent = formatNum(totalApportioned, decimalPlaces);
  document.getElementById('totalActivityRevenue').textContent = formatNum(totalActivityRevenue);
}

function handleEnterKey(event) {
  if (event.key === 'Enter') {
    event.preventDefault();
    addRow();
    
    // Focus on the segment field of the new row
    const rows = document.querySelectorAll('#inputTable tbody tr');
    const newRow = rows[rows.length - 1];
    const firstInput = newRow.querySelector('input[type="text"]');
    if (firstInput) {
      firstInput.focus();
    }
  }
}

function addRow() {
  const tbody = document.querySelector('#inputTable tbody');
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td class="row-selector-cell"><input type="checkbox" class="rowSelector"></td>
    <td><input type="text" oninput="calculate()" placeholder="Enter industry segment" class="placeholder" onfocus="clearPlaceholder(this)" onblur="restorePlaceholder(this, 'Enter industry segment')"></td>
    <td><input type="text" oninput="calculate()" placeholder="Enter specific activity" class="placeholder" onfocus="clearPlaceholder(this)" onblur="restorePlaceholder(this, 'Enter specific activity')"></td>
    <td><input type="number" oninput="calculate()" onkeydown="handleEnterKey(event)" placeholder="Enter revenue amount" class="placeholder" onfocus="clearPlaceholder(this)" onblur="restorePlaceholder(this, 'Enter revenue amount')"></td>
  `;
  tbody.appendChild(tr);
}

function toggleSelectAll() {
  const selectAll = document.getElementById('selectAll');
  const checkboxes = document.querySelectorAll('.rowSelector');
  checkboxes.forEach(checkbox => {
    checkbox.checked = selectAll.checked;
  });
}

function deleteSelectedRows() {
  const rows = document.querySelectorAll('#inputTable tbody tr');
  let hasDeleted = false;
  
  for (let i = rows.length - 1; i >= 0; i--) {
    const checkbox = rows[i].querySelector('.rowSelector');
    if (checkbox && checkbox.checked) {
      rows[i].remove();
      hasDeleted = true;
    }
  }
  
  if (hasDeleted) {
    calculate();
  }
  
  // Ensure at least one row exists
  if (document.querySelectorAll('#inputTable tbody tr').length === 0) {
    addRow();
  }
  
  // Uncheck select all
  document.getElementById('selectAll').checked = false;
}

function clearAll() {
  if (confirm('Are you sure you want to clear all data?')) {
    const tbody = document.querySelector('#inputTable tbody');
    tbody.innerHTML = '';
    addRow();
    document.getElementById('ciqRevenue').value = 0;
    calculate();
  }
}

function showExportOptions() {
  document.getElementById('exportOptionsModal').style.display = 'block';
  document.getElementById('initialsInput').value = userInitials;
  document.getElementById('uidInput').value = '1001'; // Changed default to numeric
  document.getElementById('uidInput').type = 'number'; // Change to number input
}

function hideExportOptions() {
  document.getElementById('exportOptionsModal').style.display = 'none';
}

function formatDate() {
  const now = new Date();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  const year = now.getFullYear();
  return `${month}-${day}-${year}`;
}

function exportToExcel() {
  // Get filename components
  const uid = parseInt(document.getElementById('uidInput').value || '1001');
  const date = formatDate();
  userInitials = document.getElementById('initialsInput').value || 'USER';
  localStorage.setItem('userInitials', userInitials);
  const filename = `${uid}_${date}_${userInitials}.xlsx`;

  // Create workbook and worksheet
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet([]);

  // Get input data from the table
  const inputRows = document.querySelectorAll('#inputTable tbody tr');
  const segmentActivityData = [];
  inputRows.forEach(row => {
    const inputs = row.querySelectorAll('input:not([type="checkbox"])');
    const segment = inputs[0].value.trim();
    const activity = inputs[1].value.trim();
    const revenue = inputs[2].value || 0;
    if (segment || activity || revenue) {
      segmentActivityData.push([segment, activity, parseFloat(revenue)]);
    }
  });

  // Table 1: Headers
  const table1StartRow = 3;
  ws[`C${table1StartRow}`] = { v: 'product/segment', t: 's' };
  ws[`D${table1StartRow}`] = { v: 'business activity', t: 's' };
  ws[`E${table1StartRow}`] = { v: 'revenue', t: 's' };

  // Table 1: Data
  let dataStartRow = table1StartRow + 1;
  segmentActivityData.forEach((rowData, i) => {
    ws[`C${dataStartRow + i}`] = { v: rowData[0], t: 's' };
    ws[`D${dataStartRow + i}`] = { v: rowData[1], t: 's' };
    ws[`E${dataStartRow + i}`] = { v: rowData[2], t: 'n' };
  });

  // Table 1: Fill empty rows if needed (optional, not required for dynamic)
  // Table 1: Total row
  const table1TotalRow = dataStartRow + segmentActivityData.length;
  ws[`D${table1TotalRow}`] = { v: 'total', t: 's' };
  ws[`E${table1TotalRow}`] = { f: `SUM(E${dataStartRow}:E${table1TotalRow - 1})`, t: 'f' };

  // CIQ Revenue row
  const ciqRevenue = parseFloat(document.getElementById('ciqRevenue').value || 0);
  const ciqRow = table1TotalRow + 1;
  ws[`D${ciqRow}`] = { v: 'CIQ Revenue', t: 's' };
  ws[`E${ciqRow}`] = { v: ciqRevenue, t: 'n' };

  // Table 2: Headers
  const table2HeaderRow = ciqRow + 2;
  ws[`C${table2HeaderRow}`] = { v: 'business activity', t: 's' };
  ws[`D${table2HeaderRow}`] = { v: 'Revenue', t: 's' };
  ws[`E${table2HeaderRow}`] = { v: 'Apportioned revenue', t: 's' };

  // Table 2: Unique activities
  const uniqueActivities = [];
  const activityMap = new Map();
  segmentActivityData.forEach(rowData => {
    const activity = rowData[1];
    if (activity && !activityMap.has(activity)) {
      activityMap.set(activity, true);
      uniqueActivities.push(activity);
    }
  });

  // Table 2: Data rows
  let table2DataStart = table2HeaderRow + 1;
  uniqueActivities.forEach((activity, i) => {
    const rowNum = table2DataStart + i;
    ws[`C${rowNum}`] = { v: activity, t: 's' };
    // SUMIF for revenue: D = sum of E in Table 1 where D matches activity
    ws[`D${rowNum}`] = { f: `SUMIF(D${dataStartRow}:D${table1TotalRow - 1},C${rowNum},E${dataStartRow}:E${table1TotalRow - 1})`, t: 'f' };
    // Apportioned revenue: D/total*CIQ
    ws[`E${rowNum}`] = { f: `D${rowNum}/$D$${table2TotalRow(uniqueActivities, table2DataStart)}*$E$${ciqRow}` , t: 'f' };
  });

  // Table 2: Total row
  const table2Total = table2DataStart + uniqueActivities.length;
  ws[`C${table2Total}`] = { v: 'total', t: 's' };
  ws[`D${table2Total}`] = { f: `SUM(D${table2DataStart}:D${table2Total - 1})`, t: 'f' };
  ws[`E${table2Total}`] = { f: `SUM(E${table2DataStart}:E${table2Total - 1})`, t: 'f' };

  // Set worksheet range
  ws['!ref'] = `B2:E${table2Total}`;
  ws['!cols'] = [ { width: 10 }, { width: 10 }, { width: 38.64 }, { width: 16.18 }, { width: 15 } ];

  // Add sheet to workbook
  XLSX.utils.book_append_sheet(wb, ws, "Revenue Allocation");
  XLSX.writeFile(wb, filename);
  hideExportOptions();
}

// Helper to get Table 2 total row number
function table2TotalRow(uniqueActivities, table2DataStart) { return table2DataStart + uniqueActivities.length; }

// Initialize the calculator when the page loads
document.addEventListener('DOMContentLoaded', function() {
  // Set initials input from localStorage if available
  if (userInitials) {
    document.getElementById('initialsInput').value = userInitials;
  }
  
  // Apply saved theme
  document.documentElement.setAttribute('data-theme', currentTheme);
  
  calculate();
});
</script>

</body>
</html>
